package monoton.module.impl.misc;

import monoton.control.events.client.Event;
import monoton.control.events.game.EventKey;
import monoton.module.TypeList;
import monoton.module.api.Annotation;
import monoton.module.api.Module;
import monoton.module.settings.imp.BindSetting;
import monoton.module.settings.imp.BooleanOption;
import monoton.module.settings.imp.ModeSetting;
import monoton.module.settings.imp.SliderSetting;
import monoton.utils.misc.TimerUtil;
import monoton.utils.other.OtherUtil;
import monoton.control.friend.FriendManager;
import monoton.control.friend.Friend;

import java.io.*;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Random;
import net.minecraft.entity.player.PlayerEntity;

@Annotation(name = "RegionExploit", type = TypeList.Misc, desc = "Дистанционна експлойтит регион")
public class RegionExploit extends Module {
    public final ModeSetting mode = new ModeSetting("Этот игрок", "Отправитель", "Отправитель", "Получатель");
    private final BindSetting key = new BindSetting("Заприватить", 0).setVisible(() -> mode.is("Отправитель"));
    public SliderSetting dist = new SliderSetting("Радиус", 5, 3, 15, 1, 7).setVisible(() -> mode.is("Отправитель"));
    private static final File DIR = new File("C:\\Monoton\\game\\Monoton");
    private static final File COORDS_FILE = new File(DIR, "exploit.json");
    private final TimerUtil stopWatch = new TimerUtil();
    private final BooleanOption friend = new BooleanOption("Добавлять друзей", true).setVisible(() -> mode.is("Отправитель"));

    private long lastModified = 0;

    public RegionExploit() {
        addSettings(mode, key, dist, friend);
    }

    private String lastRegionName = null;

    @Override
    public boolean onEvent(Event event) {
        if (event instanceof EventKey even) {
            if (OtherUtil.isConnectedToServer("reallyworld")) {
                toggle();
                return false;
            }
            if (mode.is("Отправитель")) {
                if (even.key == key.getKey() && stopWatch.isReached(2000)) {
                    try {
                        if (!DIR.exists()) {
                            DIR.mkdirs();
                        }

                        int x1 = (int) (mc.player.getPosX() - dist.getValue().intValue());
                        int y1 = (int) mc.player.getPosY() - dist.getValue().intValue();
                        int y2 = (int) mc.player.getPosY() + dist.getValue().intValue();
                        int z1 = (int) (mc.player.getPosZ() - dist.getValue().intValue());
                        int x2 = (int) mc.player.getPosX() + dist.getValue().intValue();
                        int z2 = (int) mc.player.getPosZ() + dist.getValue().intValue();

                        String playerName = mc.getSession().getUsername();

                        String rgrandomname = String.valueOf((long) (Math.random() * 1_000_000_000L));
                        while (rgrandomname.length() < 9) rgrandomname = "0" + rgrandomname;

                        String regionName = "mon" + rgrandomname;

                        List<String> friendNames = new ArrayList<>();
                        if (friend.get()) {
                            FriendManager friendManager = new FriendManager();
                            List<Friend> friends = friendManager.getFriends();
                            if (!friends.isEmpty()) {
                                List<Friend> shuffledFriends = new ArrayList<>(friends);
                                Collections.shuffle(shuffledFriends, new Random());
                                for (Friend f : shuffledFriends) {
                                    for (PlayerEntity player : mc.world.getPlayers()) {
                                        if (player.getName().getString().equals(f.getName())) {
                                            double dx = mc.player.getPosX() - player.getPosX();
                                            double dy = mc.player.getPosY() - player.getPosY();
                                            double dz = mc.player.getPosZ() - player.getPosZ();
                                            double distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                                            if (distance <= 200) {
                                                friendNames.add(f.getName());
                                            }
                                            break;
                                        }
                                    }
                                }
                                if (!friendNames.isEmpty()) {
                                    int numFriendsToAdd = Math.min(friendNames.size(), new Random().nextInt(3) + 1);
                                    friendNames = friendNames.subList(0, numFriendsToAdd);
                                }
                            }
                        }

                        StringBuilder coords = new StringBuilder();
                        coords.append(String.format("%d,%d,%d\n%d,%d,%d\n%s\n%s\n",
                                x1, y1, z1, x2, y2, z2, playerName, rgrandomname));
                        for (String friendName : friendNames) {
                            coords.append(friendName).append("\n");
                        }

                        try (FileWriter writer = new FileWriter(COORDS_FILE, false)) {
                            writer.write(coords.toString());
                        }

                        lastModified = COORDS_FILE.lastModified();
                        lastRegionName = regionName;
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                    new java.util.Timer().schedule(new java.util.TimerTask() {
                        @Override
                        public void run() {
                            try {
                                if (!DIR.exists()) {
                                    DIR.mkdirs();
                                }
                                double playerX = mc.player.getPosX();
                                double playerY = mc.player.getPosY();
                                double playerZ = mc.player.getPosZ();

                                int radius = dist.getValue().intValue();

                                int x1 = (int) (playerX - radius);
                                int z1 = (int) (playerZ - radius);
                                int y1 = (int) (playerY - radius);

                                int x2 = (int) (playerX + radius);
                                int z2 = (int) (playerZ + radius);
                                int y2 = (int) (playerY + radius);

                                String playerName = mc.getSession().getUsername();

                                String rgrandomname = String.valueOf((long) (Math.random() * 1_000_000_000L));
                                while (rgrandomname.length() < 9) rgrandomname = "0" + rgrandomname;

                                String regionName = "mon" + rgrandomname;

                                List<String> friendNames = new ArrayList<>();
                                if (friend.get()) {
                                    FriendManager friendManager = new FriendManager();
                                    List<Friend> friends = friendManager.getFriends();
                                    if (!friends.isEmpty()) {
                                        List<Friend> shuffledFriends = new ArrayList<>(friends);
                                        Collections.shuffle(shuffledFriends, new Random());
                                        for (Friend f : shuffledFriends) {
                                            for (PlayerEntity player : mc.world.getPlayers()) {
                                                if (player.getName().getString().equals(f.getName())) {
                                                    double dx = mc.player.getPosX() - player.getPosX();
                                                    double dy = mc.player.getPosY() - player.getPosY();
                                                    double dz = mc.player.getPosZ() - player.getPosZ();
                                                    double distance = Math.sqrt(dx * dx + dy * dy + dz * dz);
                                                    if (distance <= 200) {
                                                        friendNames.add(f.getName());
                                                    }
                                                    break;
                                                }
                                            }
                                        }
                                        if (!friendNames.isEmpty()) {
                                            int numFriendsToAdd = Math.min(friendNames.size(), new Random().nextInt(3) + 1);
                                            friendNames = friendNames.subList(0, numFriendsToAdd);
                                        }
                                    }
                                }

                                StringBuilder coords = new StringBuilder();
                                coords.append(String.format("%d,%d,%d\n%d,%d,%d\n%s\n%s\n",
                                        x1, y1, z1, x2, y2, z2, playerName, rgrandomname));
                                for (String friendName : friendNames) {
                                    coords.append(friendName).append("\n");
                                }

                                try (FileWriter writer = new FileWriter(COORDS_FILE, false)) {
                                    writer.write(coords.toString());
                                }

                                lastModified = COORDS_FILE.lastModified();
                                lastRegionName = regionName;
                            } catch (IOException e) {
                                e.printStackTrace();
                            }
                        }
                    }, 1200);
                    new java.util.Timer().schedule(new java.util.TimerTask() {
                        @Override
                        public void run() {
                            OtherUtil.sendMessage("Регион успешно создан");
                        }
                    }, 2400);
                    stopWatch.reset();
                }
            }
        }

        if (mode.is("Получатель")) {
            if (COORDS_FILE.exists()) {
                long modified = COORDS_FILE.lastModified();
                if (modified > lastModified) {
                    lastModified = modified;
                    try (BufferedReader reader = new BufferedReader(new FileReader(COORDS_FILE))) {
                        String pos1 = reader.readLine();
                        String pos2 = reader.readLine();
                        String nameplayer = reader.readLine();
                        String rgrandomname = reader.readLine();

                        List<String> friendNames = new ArrayList<>();
                        String line;
                        while ((line = reader.readLine()) != null) {
                            friendNames.add(line);
                        }

                        if (pos1 != null && pos2 != null && nameplayer != null && rgrandomname != null) {
                            String regionName = "mon" + rgrandomname;

                            if (lastRegionName != null) {
                                mc.player.sendChatMessage("/rg remove " + lastRegionName);
                            }

                            new java.util.Timer().schedule(new java.util.TimerTask() {
                                @Override
                                public void run() {
                                    mc.player.sendChatMessage("//1 " + pos1);
                                }
                            }, 800);
                            new java.util.Timer().schedule(new java.util.TimerTask() {
                                @Override
                                public void run() {
                                    mc.player.sendChatMessage("//2 " + pos2);
                                }
                            }, 1600);
                            new java.util.Timer().schedule(new java.util.TimerTask() {
                                @Override
                                public void run() {
                                    mc.player.sendChatMessage("/rg claim " + regionName);
                                }
                            }, 2400);
                            new java.util.Timer().schedule(new java.util.TimerTask() {
                                @Override
                                public void run() {
                                    mc.player.sendChatMessage("/rg addowner " + regionName + " " + nameplayer);
                                }
                            }, 3200);
                            new java.util.Timer().schedule(new java.util.TimerTask() {
                                @Override
                                public void run() {
                                    for (String friendName : friendNames) {
                                        mc.player.sendChatMessage("/rg addowner " + regionName + " " + friendName);
                                    }
                                }
                            }, 4000);
                            lastRegionName = regionName;
                        }
                    } catch (IOException e) {
                        e.printStackTrace();
                    }
                }
            }
        }

        return false;
    }
}